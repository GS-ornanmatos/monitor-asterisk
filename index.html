<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Asterisk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card-ramal {
            transition: transform 0.2s;
            border: none;
        }

        .card-ramal:hover {
            transform: translateY(-5px);
        }

        .offline-blink {
            animation: blinker 2s linear infinite;
            border: 2px solid #dc3545 !important;
            background-color: #fff5f5;
        }

        @keyframes blinker {
            50% {
                opacity: 0.7;
                border-color: transparent;
            }
        }

        #logViewer {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            background-color: #1e1e1e;
            color: #d4d4d4;
            max-height: 250px;
            overflow-y: auto;
            border-radius: 5px;
            padding: 10px;
        }

        .log-error {
            color: #ff6b6b;
            font-weight: bold;
        }

        .log-warn {
            color: #f1c40f;
        }

        .log-info {
            color: #2ecc71;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-online {
            background-color: #28a745;
            box-shadow: 0 0 5px #28a745;
        }

        .status-error {
            background-color: #dc3545;
        }
    </style>
</head>

<body>

    <div class="container mt-4 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
            <div>
                <h2 class="mb-0">CENTRAL DE ATENDIMENTO GIUSOFT</h2>
                <small class="text-muted">
                    <span id="systemStatus" class="status-dot"></span>
                    Status da Conex√£o: <span id="statusText">Aguardando...</span>
                </small>
            </div>
            <button id="btnNotif" onclick="requestNotificationPermission()" class="btn btn-outline-primary btn-sm">
                Ativar Notifica√ß√µes
            </button>
        </div>

        <div class="row g-3" id="gridRamais">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Carregando dados do servidor...</p>
            </div>
        </div>

        <div class="mt-5">
            <div class="d-flex justify-content-between align-items-end mb-2">
                <h5 class="m-0">Hist√≥rico de Eventos</h5>
                <small class="text-muted">Exibindo logs recentes</small>
            </div>
            <div id="logViewer">Carregando logs...</div>
        </div>

        <div class="text-muted text-center mt-4 small">
            Atualiza√ß√£o autom√°tica a cada 20 minutos.<br>
            √öltima sincroniza√ß√£o: <span id="lastUpdate" class="fw-bold">-</span>
        </div>
    </div>

    <script>
        const UPDATE_INTERVAL = 60000;
        const URL_JSON = 'monitor.json';
        const URL_LOG = 'monitor_historico.log';

        let previousStatus = {};

        function checkNotificationPermission() {
            if (Notification.permission === "granted") {
                document.getElementById('btnNotif').style.display = 'none';
            }
        }

        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                alert("Navegador sem suporte a notifica√ß√µes.");
                return;
            }
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    new Notification("Monitoramento Ativado!", {body: "Voc√™ ser√° avisado se um ramal cair."});
                    checkNotificationPermission();
                }
            });
        }

        function sendNotification(ramal) {
            if (Notification.permission === "granted") {
                new Notification(`‚ö†Ô∏è ALERTA: Ramal ${ramal}`, {
                    body: `O ramal ${ramal} ficou INDISPON√çVEL!`,
                    requireInteraction: true,
                    icon: "https://cdn-icons-png.flaticon.com/512/564/564619.png"
                });
            }
        }

        // L√≥gica de Renderiza√ß√£o Correta
        function renderGrid(data) {
            const grid = document.getElementById('gridRamais');
            grid.innerHTML = '';

            if (data.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-muted">Nenhum ramal monitorado.</div>';
                return;
            }

            data.forEach(item => {
                if (previousStatus[item.ramal] &&
                    previousStatus[item.ramal] !== 'Indisponivel' &&
                    item.status === 'Indisponivel') {
                    sendNotification(`${item.nome} (${item.ramal})`);
                }
                previousStatus[item.ramal] = item.status;

                let cardClass = '';
                let badgeClass = '';
                let statusIcon = '';

                switch (item.status) {
                    case 'Indisponivel':
                        cardClass = 'offline-blink';
                        badgeClass = 'bg-danger';
                        statusIcon = 'üî¥';
                        break;
                    case 'Ocupado':
                        badgeClass = 'bg-warning text-dark';
                        statusIcon = 'üìû';
                        break;
                    case 'Disponivel':
                        badgeClass = 'bg-success';
                        statusIcon = 'üü¢';
                        break;
                    case 'OFF!':
                        badgeClass = 'bg-secondary';
                        cardClass = 'opacity-75';
                        statusIcon = '';
                        break;
                    default:
                        badgeClass = 'bg-secondary';
                }

                const html = `
                <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="card shadow-sm card-ramal ${cardClass}">
                        <div class="card-body p-3 text-center">
                            <h5 class="card-title fw-bold mb-1 text-truncate" title="${item.nome}">${item.nome}</h5>
                            <span class="badge bg-light text-dark border mb-3">${item.ramal}</span>
                            
                            <span class="badge ${badgeClass} w-100 py-3 fs-6">${statusIcon} ${item.status}</span>
                        </div>
                    </div>
                </div>
            `;
                grid.innerHTML += html;
            });
        }

        async function fetchData() {
            const timestamp = new Date().getTime();
            const statusDot = document.getElementById('systemStatus');
            const statusText = document.getElementById('statusText');

            try {
                const response = await fetch(`${URL_JSON}?t=${timestamp}`);

                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);

                const data = await response.json();

                data.sort((a, b) => parseInt(a.ramal) - parseInt(b.ramal));

                renderGrid(data);

                statusDot.className = "status-dot status-online";
                statusText.innerText = "Online e Sincronizado";
                document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString();

            } catch (error) {
                console.error("Falha ao buscar dados:", error);
                statusDot.className = "status-dot status-error";
                statusText.innerText = "Falha ao ler monitor.json";
            }

            fetchLogs(timestamp);
        }

        async function fetchLogs(timestamp) {
            const logViewer = document.getElementById('logViewer');
            try {
                const response = await fetch(`${URL_LOG}?t=${timestamp}`);
                if (!response.ok) {
                    logViewer.innerHTML = '<span class="text-muted">Arquivo de log vazio ou n√£o encontrado.</span>';
                    return;
                }
                const text = await response.text();
                const formattedHTML = text.split('\n').map(line => {
                    if (!line.trim()) return '';
                    if (line.includes('FALHA') || line.includes('ERRO')) return `<span class="log-error">${line}</span>`;
                    if (line.includes('WARN')) return `<span class="log-warn">${line}</span>`;
                    return `<span class="log-info">${line}</span>`;
                }).join('<br>');

                logViewer.innerHTML = formattedHTML || '<span class="text-muted">Sem registros recentes.</span>';
                logViewer.scrollTop = logViewer.scrollHeight;
            } catch (e) {
                console.log("Log error:", e);
            }
        }

        checkNotificationPermission();
        fetchData();
        setInterval(fetchData, UPDATE_INTERVAL); 
    </script>
</body>

</html>
